# Построение графа персонажей произведения "Анна Каренина'' и его анализ

## Используемые техники
* **NER** (**N**amed **E**ntity **R**ecognition)
* **SNA** (**S**ocial **N**etwork **A**nalysis)

## Применение сетевого анализа (SNA) в задаче 

Сетевая структура романа, когда каждый персонаж представляется в виде узла, а отношения между ними представляются в виде связей с весом (за весь период встреч между героями может быть много), позволяет подробно изучить взаимодействие персонажей. Кластеризация (выделение сообществ) позволяет выделить группы персонажей, которые взаимодействуют друг с другом чаще, чем с другими героями, и подчеркнуть те сюжетные линии, которые их связывают. 

## Обработка естественного языка с помощью NER-модели 

Существует языковая модель **NER**, которая используется для выделения и классификации различных сущностей в тексте, таких как имена людей, названия организаций и др. Современная библиотека `SpaCy` для NLP на языке Python предоставляет ряд NER-моделей, одной из которых является предобученная нейросетевая модель `en_core_web_sm`. Она предназначена для английского языка и обучена на большом корпусе текстов, включая новости, википедию и т. д. С помощью нее в тексте романа будут выделены все именованные сущности. 

## Порядок решения задачи 

* Загружается модель `en_core_web_sm` и текст романа [AK.txt](data\AK.txt). Затем модель выделяет все возможные сущности в этом тексте. 

* Создается список из персонажей романа [AK_characters.csv](data\AK_characters.csv), который берется из открытых источников.

* Для каждого предложения создается список из сущностей. Затем происходит фильтрация сущностей – те сущности, которые не являются персонажами, удаляются.

* Создается окно из небольшого числа предложений (например, размером в 5) – те сущности-персонажи, которые попадают в одно окно, имеют взаимодействие, поэтому образуют связь. Это окно скользит по всему тексту, выделяя связи.

* Удаляются все связи «сам с собой». Затем одинаковые связи группируются – у связи появляется вес. 

* Разные сущности, которые относятся к одному персонажу, сливаются в одну сущность, чтобы не было дублирования вершин и связей. Это одна из главных сложностей при реализации данной задачи. 

* На основе полученных связей [relationship.xlsx](data\relationship.xlsx) строится граф и проводится его анализ с помощью **метода Лувена**.

## Используемые библиотеки

`SpaCy`, `networkX`, `pandas`, `pyvis`, `community`

## Анализ получившейся сети и ее разбиения на сообщества 

В полученной сети (см. рис.) имеется 118 вершин и 292 ребра. Алгоритм Лувена обнаружил 7 кластеров. **Модулярность** кластеризации $Q=0.42$, что является показателем неплохого разбиения. 

Имеется 4 основных кластера, которые включают в себя большинство вершин. В произведении «Анна Каренина» 4 главных персонажа, вокруг которых крутятся свои сюжетные линии. Четыре главных героя – Анна Каренина, Алексей Вронский, Екатерина Щербацкая (Китти), Константин Левин –  являются центральными узлами в своих сообществах, их вершины являются наиболее крупными с точки зрения важности (от степени зависит размер вершины). Главные персонажи взаимодействуют и друг с другом, причем толщина их связей также является важным показателем – чем она толще, тем больше взаимодействия. Видим, что толстые ребра связывают тех главных героев, между которыми есть романтическая линия (Каренина и Вронский, Китти и Левин). Среди второстепенных персонажей наиболее важны те, кто имеет большую связь с главными героями. 

Также выделен кластер (он обозначен голубым цветом), в котором включены персонажи, играющие роль связующих разные сюжетные линии лиц. Их появления являются сквозными на протяжении всего романа, но назвать их главными героями нельзя. Выделено сообщество персонажей дома Карениных (Каренин, сын Сережа, слуги), но в него не входит сама Анна Каренина. Самым маленьким кластером выделены философы, которых читал Левин почти в конце романа. 

Разбиение социального графа взаимодействий персонажей романа «Анна Каренина» на сообщества позволяет лучше понять, как связаны различные персонажи между собой и как они влияют друг на друга в течение всего романа.

![](data\graph.png)